import requests
from time import *


# VARIABLES
SPOTIFY_ACCESS_TOKEN = input('Enter your token here: ')
SPOTIFY_GET_CURRENT_TRACK_URL = 'https://api.spotify.com/v1/me/player'
time_remaining = 0

# LISTS
favorite_artists = ["Juice World", "Lil Tjay", "Polo G", "Lil Loaded", "YNW Melly", "XXXTENTACION", "NLE Choppa"]


# MAIN FUNCTION
def get_current_track(access_token):
    # ACCESS SONG INFORMATION

    global time_remaining
    response = requests.get(
        SPOTIFY_GET_CURRENT_TRACK_URL,

        headers={
            "Authorization": f"Bearer {access_token}"
        }
    )
    resp_json = response.json()

    # SONG INFO
    track_name = resp_json['item']['name']
    track_popularity = resp_json['item']['popularity']

    track_duration = resp_json['item']['duration_ms']
    track_total_runtime = track_duration // 1000
    track_progress_runtime = resp_json['progress_ms'] // 1000
    time_remaining = track_total_runtime - track_progress_runtime

    track_volume = resp_json['device']['volume_percent']

    artists = resp_json['item']['artists']
    artists_names = ', '.join(
        [artist['name'] for artist in artists]
    )

    link = resp_json['item']['external_urls']['spotify']

    # PUTTING ALL THE SONG INFO INTO A DICTIONARY, SO YOU CAN CALL SPECIFIC PIECES OF THE SONGS INFO, AND/OR PRINT IT
    current_track_info = {
        "Name": track_name,
        "Artist": artists_names,
        "Popularity": track_popularity,
        "Link": link,
        "Volume": track_volume,
        "Duration(sec)": track_total_runtime,
        "Progress(sec)": track_progress_runtime,
        "Time remaining(sec)": time_remaining
    }

    # PRINT THE INFORMATION ONTO THE CONSOLE
    for key, value in current_track_info.items():
        print(key, ':', value)

    for a in favorite_artists:
        if a in current_track_info["Artist"]:
            requests.put(f'https://api.spotify.com/v1/me/player/volume?volume_percent=50', headers={
                "Authorization": f"Bearer {access_token}"
            })
        else:
            requests.put(f'https://api.spotify.com/v1/me/player/volume?volume_percent=30', headers={
                "Authorization": f"Bearer {access_token}"
            })

    return ''


# RUN CODE AFTER EVERY SONG
while True:
    current_track_info = get_current_track(
        SPOTIFY_ACCESS_TOKEN
    )
    sleep(time_remaining - 1)
    print(end='\n')
    print(current_track_info)
